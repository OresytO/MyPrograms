#include <vcl.h>
#pragma hdrstop

#include "Unit1.h"
#include "Unit2.h"
#include "Unit3.h"
#include "Unit4.h"
#include "Unit5.h"
#include "Unit6.h"
#include "Unit7.h"
#include "Unit8.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma link "Word_2K_SRVR"
#pragma resource "*.dfm"
TFShow *FShow;

int Forwarder_id[100];
int Sign_id[100];
bool forwarder_check = false, sign_check = false, select_check = false;

String FieldStr[11] = {	"дата_відправки",
						"дата_одержання",
    					"вартість_перевезення",
    					"кількість_місць",
    					"габарит",
    					"вага",
    					"відправник",
    					"одержувач",
    					"статус",
    					"перевізник",
    					"вид_відправки" };

//int i = 0;

bool checking(){
	//Привентивні міри захисту від дурнів :)
    if(FShow->ADODataSet1->IsEmpty()){
    	MessageBox(0, "Зробіть вибірку", "Помилка", MB_OK);
        FShow->ComboBox2->ItemIndex = -1;
    	FShow->ComboBox3->ItemIndex = -1;
    	return false;
    } else if(FShow->ComboBox2->Text == "Додати до списку"){
    	AddingForwarder();
        FShow->ComboBox2->ItemIndex = -1;
        return false;
    } else if(FShow->ComboBox3->Text == "Додати до списку"){
    	AddingForwarder();
        FShow->ComboBox3->ItemIndex = -1;
        return false;
    } else if(FShow->ComboBox2->Text.IsEmpty()){
        MessageBox(0, "Оберіть експедитора із списку", "Помилка", MB_OK);
        FShow->ComboBox2->ItemIndex = -1;
    	return false;
    } else if(FShow->ComboBox3->Text.IsEmpty()){
        MessageBox(0, "Оберіть особу, що підпише довіреність, із списку", "Помилка", MB_OK);
        //FShow->ComboBox2->ItemIndex = -1;
    	return false;
    } else if(!FShow->DBGrid1->SelectedRows->Count){
        MessageBox(0, "Виділіть декількі стрічок з результатів вибірки", "Помилка", MB_OK);
        FShow->ComboBox2->ItemIndex = -1;
    	FShow->ComboBox3->ItemIndex = -1;
    	return false;
    }
    /**/
    return true;
}

//---------------------------------------------------------------------------
__fastcall TFShow::TFShow(TComponent* Owner)
	: TForm(Owner)
{
}
//---------------------------------------------------------------------------

void __fastcall TFShow::FormClose(TObject *Sender, TCloseAction &Action)
{
	exit(1);
}
//---------------------------------------------------------------------------

void __fastcall TFShow::FormCreate(TObject *Sender)
{
    /* Login details */
    String UserName = "root";//"user"; //"db_user_name";
    String PassWord = ""; //"db_pass_word";
    String Server = "Rebok2_DB";

    DBGrid1->Options = TDBGridOptions(DBGrid1->Options) >> dgEditing
    	<< dgRowSelect << dgMultiSelect << dgIndicator << dgTitles
        << dgColLines << dgRowLines << dgColumnResize;

    /* Connection String */
    /*
    String ConnString ="Provider=MSDASQL.1;";
    ConnString += "Persist Security Info=False;";
    ConnString += "User ID=%s;"; //user;";
    ConnString += "Data Source=%s;"; //Rebok2_DB;";
    ConnString += "Mode=ReadWrite;";
    ConnString += "Initial Catalog=rebok2_db1";
    */
    DateTimePicker1->Date = Now()-10;
    DateTimePicker2->Date = Now()+10;
    DateTimePicker3->Date = Now()-10;
    DateTimePicker4->Date = Now()+10;
}
//---------------------------------------------------------------------------
void __fastcall TFShow::ComboBox1Change(TObject *Sender)
{
    ADODataSet1->Close();
    ADODataSet1->CommandText = "SELECT * FROM `" + ComboBox1->Text + "`;";
    ADODataSet1->Open();
}
//---------------------------------------------------------------------------
void __fastcall TFShow::BBackClick(TObject *Sender)
{
	FShow->Visible = false;
    FStart->Visible = true;
}
//---------------------------------------------------------------------------
void __fastcall TFShow::BExitClick(TObject *Sender)
{
    /*
	if(fStart){
    	vVarApp.OleProcedure("Quit");
    }
    /**/
	Close();
}
//---------------------------------------------------------------------------
void __fastcall TFShow::SelectionClick(TObject *Sender)
{
	select_check = true;
	String SQLStr;
    SQLStr = "SELECT * FROM `delivery_app` WHERE ";

    if(RadioButton1->Checked) SQLStr += " статус = 'ні'  AND ";
    else if(RadioButton2->Checked) SQLStr += " статус = 'так'  AND ";

    if(RadioButton4->Checked) SQLStr += " вид_відправки = 'вхідна' AND ";
    else if(RadioButton5->Checked) SQLStr += " вид_відправки = 'вихідна' AND ";

    if(DateTimePicker1->Date < DateTimePicker2->Date){
    	SQLStr += " дата_відправки >= '" + DateTimePicker1->Date.FormatString("YYYY.MM.DD");
    	SQLStr += "' AND ";
    	SQLStr += " дата_відправки <= '" + DateTimePicker2->Date.FormatString("YYYY.MM.DD");
    }
    else{
    	ShowMessage("Помилка задання дати. Дата 'з' має бути меньшою від дати 'до'!!!");
    	return;
    }

    if(DateTimePicker3->Date < DateTimePicker4->Date){
    	SQLStr += "' AND дата_одержання >= '" + DateTimePicker3->Date.FormatString("YYYY.MM.DD");
    	SQLStr += "' AND ";
    	SQLStr += " дата_одержання <= '" + DateTimePicker4->Date.FormatString("YYYY.MM.DD");
    }
    else{
    	ShowMessage("Помилка задання дати. Дата 'з' має бути меньшою від дати 'до'!!!");
    	return;
    }
    SQLStr += "';";

    ADODataSet1->Close();
    ADODataSet1->CommandText = SQLStr;
    ADODataSet1->Open();
}
//---------------------------------------------------------------------------

void __fastcall TFShow::ComboBox2Change(TObject *Sender)
{
    if(!checking())return;
    else {
    	String SQLStr;

    	SQLStr = "DROP VIEW IF EXISTS `sel_deliv`; ";
    	ADOCommand1->CommandText = SQLStr;
    	ADOCommand1->Execute();

    	SQLStr = "CREATE VIEW `sel_deliv` AS ";
    	SQLStr += "SELECT * FROM `delivery_app` WHERE id IN (";

        int count = DBGrid1->SelectedRows->Count;
        DataSource1->DataSet->First();
	 	DataSource1->DataSet->DisableControls();

	 	while(!DataSource1->DataSet->Eof)
	 	{
	 		if(DBGrid1->SelectedRows->CurrentRowSelected){
	        	SQLStr += ADODataSet1->FieldByName("id")->AsString;
                if(--count)SQLStr += ", ";
            	else SQLStr += ");";
	        }
	  		DataSource1->DataSet->Next();
	 	}
	 	DataSource1->DataSet->EnableControls();

        ADOCommand1->CommandText = SQLStr;
    	ADOCommand1->Execute();

        ADODataSet3->Close();
    	ADODataSet3->CommandText = "SELECT * FROM `sel_deliv`;";
    	ADODataSet3->Open();
    }
}
//---------------------------------------------------------------------------

void __fastcall TFShow::ComboBox2DropDown(TObject *Sender)
{
	//ComboDropFor(ComboBox2, ADODataSet2, Forwarder_id);
    String SQLstr = "SELECT forwarder_id, `name` FROM `rebok2_db1`.`forwarder`;";
	ComboDropList(ComboBox2, ADODataSet2, SQLstr, Forwarder_id);
}
//---------------------------------------------------------------------------

void __fastcall TFShow::ComboBox3DropDown(TObject *Sender)
{
	//ComboDropFor(ComboBox3, ADODataSet5, Sign_id);
    String SQLstr = "SELECT forwarder_id, `name` FROM `rebok2_db1`.`forwarder` WHERE sign = 'так';";
    ComboDropList(ComboBox3, ADODataSet5, SQLstr, Sign_id);
}
//---------------------------------------------------------------------------

void __fastcall TFShow::ComboBox3Change(TObject *Sender)
{
    //if(!checking())return;
    if(FShow->ComboBox3->Text == "Додати до списку"){
    	AddingForwarder();
        FShow->ComboBox3->ItemIndex = -1;
        return sign_check = false;
    } else if(FShow->ComboBox2->Text.IsEmpty()){
        MessageBox(0, "Оберіть експедитора із списку", "Помилка", MB_OK);
        FShow->ComboBox2->ItemIndex = -1;
    	return sign_check = false;
    }
    sign_check = true;

}
//---------------------------------------------------------------------------

void __fastcall TFShow::BPrint_documentsClick(TObject *Sender)
{
	//if(!checking()) return;

    if(FShow->ComboBox3->Text == "Додати до списку"){
    	AddingForwarder();
        FShow->ComboBox3->ItemIndex = -1;
        return false;
    } else if(FShow->ComboBox2->Text.IsEmpty()){
        MessageBox(0, "Оберіть експедитора із списку", "Помилка", MB_OK);
        FShow->ComboBox2->ItemIndex = -1;
    	return false;

    sign_check = true;
    Variant vVarApp, vVarDocs, vVarDoc, vVarParagraphs, vVarParagraph,
    		vVarBookmark, Selection, vVarCell, vVarTable, vVarRange;
    String SQLStr;//, str;
    int courier_count, recCount;
    const int bkCount = 10;
    AnsiString Text[bkCount], path;
    AnsiString BookmarkNames[bkCount] = {	"Адреса_складу_перевізника",
    										"Телефони_складу_перевізника",
                                			"Тип_документу_посвідки_особи",
                                			"Назва_перевізника_та_номер_складу",
                                			"Дата_створення_документу",
                                			"Номер_Доручення",
                                			"Посада_особи_що_підписала_документ",
                                			"Особа_що_підписала_документ",
                                			"ПІБ", //"Імя",
                                			"Серія_та_номер_посвідчення_особи"};

    SQLStr = "SELECT COUNT(DISTINCT перевізник) courier_count FROM `sel_deliv`;";
    ADODataSet4->Close();
    ADODataSet4->CommandText = SQLStr;
    ADODataSet4->Open();

    courier_count = ADODataSet4->Fields->FieldByNumber(1)->AsInteger;

    SQLStr = "DROP VIEW IF EXISTS `sel_courier_list`; ";
    ADOCommand1->CommandText = SQLStr;
    ADOCommand1->Execute();

    SQLStr = "CREATE VIEW `sel_courier_list` AS ";
    SQLStr += "SELECT c.adress, c.name_storage_number, ";
    SQLStr += "concat_ws(' ', c.phone_1, c.phone_2, c.phone_3) phone, c.passport_for_id ";
    SQLStr += "FROM courier c ";
    SQLStr += "NATURAL JOIN sel_deliv  sl ";
    SQLStr += "WHERE sl.перевізник = c.name_storage_number ";
    SQLStr += "GROUP BY c.adress; ";
    ADOCommand1->CommandText = SQLStr;
    ADOCommand1->Execute();

    //if(!fStart){
    try{
    	vVarApp = CreateOleObject("Word.Application");
        //fStart = true;
    }catch(...){
    	MessageBox(0, "Помилка сервера Word", "Помилка", MB_OK);
        return;
    }
    vVarApp.OlePropertySet("Visible", true);
    //Перевірка орфографії
  	vVarApp.OlePropertyGet("Options").OlePropertySet("CheckGrammarAsYouType",false);
  	vVarApp.OlePropertyGet("Options").OlePropertySet("CheckGrammarWithSpelling",false);
    //}




    for(int i = 0; i < courier_count; i++){
    	SQLStr = "SELECT * FROM `sel_courier_list` LIMIT " + IntToStr(i) + ", 1; ";
       	ADODataSet4->Close();
   		ADODataSet4->CommandText = SQLStr;
   		ADODataSet4->Open();

        Text[0] = ADODataSet4->Fields->FieldByName("adress")->AsString;
        Text[1] = ADODataSet4->Fields->FieldByName("phone")->AsString;
        Text[2] = ADODataSet4->Fields->FieldByName("passport_for_id")->AsString;
        Text[3] = ADODataSet4->Fields->FieldByName("name_storage_number")->AsString;
        Text[4] = Now().CurrentDate().FormatString("YYYY.MM.DD");

        SQLStr = "SELECT MAX(№_power_of_attorney + 1) new_№ FROM `power_of_attorney`;";
        ADODataSet4->Close();
        ADODataSet4->CommandText = SQLStr;
        ADODataSet4->Open();
        Text[5] = ADODataSet4->Fields->FieldByName("new_№")->AsString;

        SQLStr = "SELECT job_title, `name` FROM `forwarder` WHERE forwarder_id = " + IntToStr(Sign_id[ComboBox3->ItemIndex]) + " ;";
        ADODataSet4->Close();
        ADODataSet4->CommandText = SQLStr;
        ADODataSet4->Open();
        Text[6] = ADODataSet4->Fields->FieldByName("job_title")->AsString;
        Text[7] = ADODataSet4->Fields->FieldByName("name")->AsString;

        AnsiString id[2]={"паспорт", "посвідчення водія"};
        if(Text[2] == id[0])SQLStr = "SELECT code_№_passport document, ";
        else if(Text[2] == id[1]) SQLStr = "SELECT code_№_driver_lice document, ";
        else{
        	MessageBox(0, "Помилка вибору документу, що підтверджує особу", "Помилка", MB_OK);
            return;
        }
        SQLStr += "`name` FROM `forwarder` WHERE forwarder_id = " + IntToStr(Forwarder_id[ComboBox2->ItemIndex]) + " ;";
        ADODataSet4->Close();
        ADODataSet4->CommandText = SQLStr;
        ADODataSet4->Open();
        Text[8] = ADODataSet4->Fields->FieldByName("name")->AsString;
        Text[9] = ADODataSet4->Fields->FieldByName("document")->AsString;

        vVarDocs = vVarApp.OlePropertyGet("Documents");
        path = ExtractFilePath(Application->ExeName) + "\Templat.dot";
    	vVarDocs.OleProcedure("Add", path.c_str(), false, 0);
        vVarDoc = vVarDocs.OleFunction("Item", 1);// Зробити для "ActiveDocument"
        Selection = vVarApp.OlePropertyGet("Selection");
        for(int i = 0; i < bkCount; i++){
        	Selection.OleFunction("GoTo", 4294967295, 0, 0, BookmarkNames[i].c_str());
            //4294967295 значение wdGoToBookmark из MSWORD.IDL

            //Кожній закладці із шаблону Word встановлюється відповідне значення
            Selection.OlePropertySet("Text", Text[i].c_str());
        }
        /**/
        //Дізнаємось скільки відправок із вибраних припадає на даного перевізника
        SQLStr = "SELECT кількість_місць,  №_декларації, дата_одержання FROM sel_deliv WHERE перевізник = \"" + Text[3] + "\";";
        ADODataSet4->Close();
        ADODataSet4->CommandText = SQLStr;
        ADODataSet4->Open();

        recCount = ADODataSet4->RecordCount + 1;

        //Створення таблиці на місці закладки з іменем "Таблиця"
        Selection = vVarApp.OlePropertyGet("Selection");
        vVarRange = Selection.OleFunction("GoTo", 4294967295, 0, 0, "Таблиця");
        vVarDoc.OlePropertyGet("Tables").OleProcedure("Add", vVarRange, recCount, 4, 1, 2);
        vVarTable = vVarDoc.OlePropertyGet("Tables").OleFunction("Item", 2);

        //Формування заголовку таблиці
        vVarCell = vVarTable.OleFunction("Cell", 1, 1);
        vVarCell.OleFunction("Select");
        vVarCell.OlePropertyGet("Range").OlePropertySet("Text","№ п/п");

        vVarCell = vVarTable.OleFunction("Cell", 1, 2);
        vVarCell.OleFunction("Select");
        vVarCell.OlePropertyGet("Range").OlePropertySet("Text","Номер декларації");

        vVarCell = vVarTable.OleFunction("Cell", 1, 3);
        vVarCell.OleFunction("Select");
        vVarCell.OlePropertyGet("Range").OlePropertySet("Text","Дата надходження");

        vVarCell = vVarTable.OleFunction("Cell", 1, 4);
        vVarCell.OleFunction("Select");
        vVarCell.OlePropertyGet("Range").OlePropertySet("Text","місць");
        /*
        //Добавляем строки
  		vVarTable = vVarDoc.OlePropertyGet("Tables").OleFunction("Item", 1);
  		Variant v = vVarTable.OlePropertyGet("Rows").OleFunction("Item", 2).OleFunction("Select");
  		for(int i = 0; i < recCount; i++){
        //Строку Ниже
        vVarAppWord.OlePropertyGet("Selection").OleProcedure("InsertRowsBelow",1);
        }
        /**/

        //Заповнення таблиці в Word
        for(int i = 2; i < recCount + 1; i++){

            // Виділення певної комірки
        	vVarCell = vVarTable.OleFunction("Cell", i, 1); // x та y це координати комірки
			vVarCell.OleFunction("Select");
        	// Вставка тексту у виділену комірку таблиці
            vVarCell.OlePropertyGet("Range").OlePropertySet("Text", IntToStr(i - 1).c_str());

            // Виділення певної комірки
        	vVarCell = vVarTable.OleFunction("Cell", i, 2); // x та y це координати комірки
			vVarCell.OleFunction("Select");
        	// Вставка тексту у виділену комірку таблиці
            SQLStr = ADODataSet4->Fields->FieldByName("№_декларації")->AsString;
            vVarCell.OlePropertyGet("Range").OlePropertySet("Text", SQLStr.c_str());

            // Виділення певної комірки
        	vVarCell = vVarTable.OleFunction("Cell", i, 3); // x та y це координати комірки
			vVarCell.OleFunction("Select");
        	// Вставка тексту у виділену комірку таблиці
            SQLStr = ADODataSet4->Fields->FieldByName("дата_одержання")->AsString;
            vVarCell.OlePropertyGet("Range").OlePropertySet("Text", SQLStr.c_str());

            // Виділення певної комірки
        	vVarCell = vVarTable.OleFunction("Cell", i, 4); // x та y це координати комірки
			vVarCell.OleFunction("Select");
        	// Вставка тексту у виділену комірку таблиці
            SQLStr = ADODataSet4->Fields->FieldByName("кількість_місць")->AsString;
            vVarCell.OlePropertyGet("Range").OlePropertySet("Text", SQLStr.c_str());
            /**/
            ADODataSet4->Next();
        }
        /**/
        //Встановлення місця збереження та імені нового доручення
        path = "D:\\MySQL_2\\declar_" + Text[5] + ".doc";

        //vVarDoc.OleProcedure("SaveAs", path.c_str()); // , true
        /*
        //Роздрук поточного документу
        //Установить активный  принтер
		//vVarApp.OlePropertySet("ActivePrinter","Epson LQ-100 ESC/P 2 on LPT1:");
        str = Printer()->Printers->Text ;
        vVarApp.OlePropertySet("ActivePrinter","Epson LQ-100 ESC/P 2 on LPT1:");
        /**/
        //Закриття документу Word
        //vVarDocs.OleProcedure("Close"); // , path.c_str()

        //Додавання в таблицю power_of_attorney нового запису
        SQLStr = "INSERT INTO `power_of_attorney` (power_of_attorney_id, ";
        SQLStr += "power_of_attorney_date, №_power_of_attorney, ";
        SQLStr += "sign_id, forwarder_id) VALUES ('', '";
        SQLStr += Text[4] + "', '";
        SQLStr += Text[5] + "', ";
        SQLStr += IntToStr(Sign_id[ComboBox3->ItemIndex]) + ", ";
        SQLStr += IntToStr(Forwarder_id[ComboBox2->ItemIndex]) + ");";
        ADOCommand1->CommandText = SQLStr;
        ADOCommand1->Execute();
    }

    //vVarApp.OleProcedure("Quit");
}
//---------------------------------------------------------------------------

void __fastcall TFShow::BitBtn2Click(TObject *Sender)
{
    //Роздрук поточного документу
    //Установить активный  принтер
    //vVarApp.OlePropertySet("ActivePrinter","Epson LQ-100 ESC/P 2 on LPT1:");
    Label6->Caption = Printer()->Printers->Text;
    PrintDialog1->Execute();
    //Label6->Caption = PrintDialog1->;
    //vVarApp.OlePropertySet("ActivePrinter","Epson LQ-100 ESC/P 2 on LPT1:");
}
//---------------------------------------------------------------------------




